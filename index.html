<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>体重与体脂率变化趋势分析</title>
    <script src="./echarts.js"></script>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4efe9 100%);
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            padding: 25px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .chart-container {
            height: 500px;
            margin-bottom: 30px;
        }
        .summary {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 20px;
            border-radius: 4px;
            margin: 25px 0;
        }
        .summary h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .metrics {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .metric-card {
            flex: 1;
            min-width: 200px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        .metric-card h4 {
            margin: 0 0 10px 0;
            color: #7f8c8d;
            font-size: 14px;
            font-weight: 500;
        }
        .metric-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }
        .metric-card .change {
            font-size: 14px;
            margin-top: 5px;
        }
        .positive {
            color: #27ae60;
        }
        .negative {
            color: #e74c3c;
        }
        .period-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .period-btn {
            padding: 8px 16px;
            margin: 0 5px;
            background: #ecf0f1;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        .period-btn.active {
            background: #3498db;
            color: white;
        }
        @media (max-width: 768px) {
            .metrics {
                flex-direction: column;
            }
            .chart-container {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>体重与体脂率变化趋势分析</h1>
        <div class="subtitle">2024年7月30日 - 2025年8月22日</div>
        
        <div class="metrics">
            <div class="metric-card">
                <h4>初始体重</h4>
                <div class="value">205.0 斤</div>
                <div class="change">2024年7月30日</div>
            </div>
            <div class="metric-card">
                <h4>当前体重</h4>
                <div class="value">150.0 斤</div>
                <div class="change">2025年8月22日</div>
            </div>
            <div class="metric-card">
                <h4>体重变化</h4>
                <div class="value">-55.0 斤</div>
                <div class="change positive">↓ 26.8%</div>
            </div>
            <div class="metric-card">
                <h4>体脂率变化</h4>
                <div class="value">45% → 37%</div>
                <div class="change positive">↓ 8.0%</div>
            </div>
        </div>

        <div class="period-toggle">
            <button class="period-btn active" data-period="all">全部数据</button>
            <button class="period-btn" data-period="3months">近3个月</button>
            <button class="period-btn" data-period="1month">近1个月</button>
        </div>

        <div id="chart" class="chart-container"></div>

        <div class="summary">
            <h3>健康分析摘要</h3>
            <p>根据您的体重变化数据，从2024年7月30日至2025年8月22日，您成功减重55斤，体脂率从45%下降到37%。这是一个非常显著的成就！</p>
            <p>您的减重过程显示出持续下降的趋势，特别是在2025年4月至8月期间，减重速度加快。值得注意的是，体脂率的变化相对体重变化较为平缓，建议在后续减重计划中增加力量训练，以提高肌肉比例，进一步改善身体成分。</p>
        </div>
    </div>

    <div class="summary">
        <h3>个人基础信息</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <input type="number" id="userHeight" placeholder="身高(cm)" step="0.1" style="width: 150px;">
            <input type="number" id="userAge" placeholder="年龄" step="1" style="width: 100px;">
            <select id="userGender" style="width: 120px; padding: 8px;">
                <option value="male">男</option>
                <option value="female">女</option>
            </select>
            <button onclick="saveUserInfo()" style="padding: 8px 16px; background: #9b59b6; color: white; border: none; border-radius: 4px; cursor: pointer;">保存基础信息</button>
        </div>
    </div>

    <div class="summary">
        <h3>健康数据录入</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px;">
            <div style="display: flex; flex-direction: column;">
                <label for="inputDate">日期</label>
                <input type="date" id="inputDate" value="">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="inputWeight">体重(斤)</label>
                <input type="number" id="inputWeight" placeholder="体重(斤)" step="0.1">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="inputFatRate">体脂率(%)</label>
                <input type="number" id="inputFatRate" placeholder="体脂率(%)" step="0.1">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="inputMuscleMass">肌肉量(kg)</label>
                <input type="number" id="inputMuscleMass" placeholder="肌肉量(kg)" step="0.1">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="inputWaterRate">水分率(%)</label>
                <input type="number" id="inputWaterRate" placeholder="水分率(%)" step="0.1">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="inputVisceralFat">内脏脂肪等级</label>
                <input type="number" id="inputVisceralFat" placeholder="内脏脂肪等级" step="0.5">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="inputBoneMass">骨量(kg)</label>
                <input type="number" id="inputBoneMass" placeholder="骨量(kg)" step="0.1">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="inputWaist">腰围(cm)</label>
                <input type="number" id="inputWaist" placeholder="腰围(cm)" step="0.1">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="inputHip">臀围(cm)</label>
                <input type="number" id="inputHip" placeholder="臀围(cm)" step="0.1">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="inputSystolic">收缩压(mmHg)</label>
                <input type="number" id="inputSystolic" placeholder="收缩压" step="1">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="inputDiastolic">舒张压(mmHg)</label>
                <input type="number" id="inputDiastolic" placeholder="舒张压" step="1">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="inputHeartRate">心率(次/分)</label>
                <input type="number" id="inputHeartRate" placeholder="静息心率" step="1">
            </div>
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button onclick="addData()" style="padding: 8px 24px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">添加/更新数据</button>
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="exportData()" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">导出数据</button>
            <label style="padding: 8px 16px; background: #f39c12; color: white; border: none; border-radius: 4px; cursor: pointer; display: inline-block;">
                导入数据
                <input type="file" id="importFile" accept=".json" onchange="importData(event)" style="display: none;">
            </label>
        </div>
    </div>

    <script>
        // 数据管理
        let rawData = [];
        let userInfo = {};
        const STORAGE_KEY = 'healthData';
        const USER_INFO_KEY = 'userHealthInfo';

        // 初始化数据
        async function initData() {
            // 加载用户基础信息
            const storedUserInfo = localStorage.getItem(USER_INFO_KEY);
            if (storedUserInfo) {
                userInfo = JSON.parse(storedUserInfo);
                // 填充到表单
                document.getElementById('userHeight').value = userInfo.height || '';
                document.getElementById('userAge').value = userInfo.age || '';
                document.getElementById('userGender').value = userInfo.gender || 'male';
            }

            // 加载健康数据
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                rawData = JSON.parse(storedData);
            } else {
                // 从JSON文件加载初始数据
                try {
                    const response = await fetch('./data.json');
                    rawData = await response.json();
                    // 保存到localStorage
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(rawData));
                } catch (error) {
                    console.error('Failed to load initial data:', error);
                    rawData = [];
                }
            }
            updateChart();
            updateMetrics();
        }

        // 保存数据到localStorage
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(rawData));
        }

        // 保存用户基础信息
        function saveUserInfo() {
            const height = parseFloat(document.getElementById('userHeight').value);
            const age = parseInt(document.getElementById('userAge').value);
            const gender = document.getElementById('userGender').value;

            if (isNaN(height) || isNaN(age)) {
                alert('请填写有效的身高和年龄');
                return;
            }

            userInfo = { height, age, gender };
            localStorage.setItem(USER_INFO_KEY, JSON.stringify(userInfo));
            alert('基础信息保存成功');
        }

        // 计算BMI
        function calculateBMI(weight, height) {
            if (!weight || !height) return null;
            const weightKg = weight / 2; // 转换为千克
            const heightM = height / 100; // 转换为米
            return (weightKg / (heightM * heightM)).toFixed(1);
        }

        // 计算基础代谢率(BMR) - 使用Mifflin-St Jeor公式
        function calculateBMR(weight, height, age, gender) {
            if (!weight || !height || !age || !gender) return null;
            const weightKg = weight / 2; // 转换为千克
            const heightCm = height; // 身高已经是厘米
            
            if (gender === 'male') {
                return (10 * weightKg) + (6.25 * heightCm) - (5 * age) + 5;
            } else {
                return (10 * weightKg) + (6.25 * heightCm) - (5 * age) - 161;
            }
        }

        // 计算腰臀比
        function calculateWHR(waist, hip) {
            if (!waist || !hip) return null;
            return (waist / hip).toFixed(2);
        }

        // 计算瘦体重（去脂体重）
        function calculateLeanBodyMass(weight, fatRate) {
            if (!weight || !fatRate) return null;
            return (weight * (1 - fatRate / 100)).toFixed(1);
        }

        // 计算脂肪重量
        function calculateFatMass(weight, fatRate) {
            if (!weight || !fatRate) return null;
            return (weight * (fatRate / 100)).toFixed(1);
        }

        // 计算肌肉率
        function calculateMuscleRate(muscleMass, weight) {
            if (!muscleMass || !weight) return null;
            return ((muscleMass * 2 / weight) * 100).toFixed(1); // 转换为斤计算
        }

        // 计算理想体重
        function calculateIdealWeight(height, gender) {
            if (!height || !gender) return null;
            let idealWeightKg;
            if (gender === 'male') {
                idealWeightKg = (height - 80) * 0.7;
            } else {
                idealWeightKg = (height - 70) * 0.6;
            }
            return (idealWeightKg * 2).toFixed(1); // 转换为斤
        }

        // 计算血压风险等级
        function calculateBloodPressureLevel(systolic, diastolic) {
            if (!systolic || !diastolic) return 'N/A';
            if (systolic < 120 && diastolic < 80) return '正常';
            if (systolic >= 120 && systolic <= 139 || diastolic >= 80 && diastolic <= 89) return '高血压前期';
            if (systolic >= 140 && systolic <= 159 || diastolic >= 90 && diastolic <= 99) return '高血压1级';
            return '高血压2级';
        }

        // 计算BMI风险等级
        function calculateBMILevel(bmi) {
            if (!bmi) return 'N/A';
            const bmiNum = parseFloat(bmi);
            if (bmiNum < 18.5) return '偏瘦';
            if (bmiNum >= 18.5 && bmiNum <= 23.9) return '正常';
            if (bmiNum >= 24.0 && bmiNum <= 27.9) return '超重';
            return '肥胖';
        }

        // 计算腰臀比风险等级
        function calculateWHRLevel(whr, gender) {
            if (!whr || !gender) return 'N/A';
            const whrNum = parseFloat(whr);
            if (gender === 'male' && whrNum < 0.90 || gender === 'female' && whrNum < 0.85) return '正常';
            return '中心性肥胖';
        }

        // 计算内脏脂肪风险等级
        function calculateVisceralFatLevel(visceralFat) {
            if (!visceralFat) return 'N/A';
            if (visceralFat < 10) return '正常';
            if (visceralFat >= 10 && visceralFat <= 14) return '偏高';
            return '肥胖';
        }

        // 显示当日指标
        function showDailyMetrics(date) {
            // 查找当日数据
            const dailyData = rawData.find(item => item.date === date);
            if (!dailyData) {
                return;
            }

            // 手动计算BMI（因为原始数据中可能没有）
            let bmi = dailyData.bmi;
            if (!bmi && userInfo.height) {
                bmi = calculateBMI(dailyData.weight, userInfo.height);
            }

            // 手动计算BMR（因为原始数据中可能没有）
            let bmr = dailyData.bmr;
            if (!bmr && userInfo.height && userInfo.age && userInfo.gender) {
                bmr = calculateBMR(dailyData.weight, userInfo.height, userInfo.age, userInfo.gender);
                bmr = bmr ? Math.round(bmr) : null;
            }

            // 计算衍生指标
            const leanBodyMass = calculateLeanBodyMass(dailyData.weight, dailyData.fatRate);
            const fatMass = calculateFatMass(dailyData.weight, dailyData.fatRate);
            const muscleRate = calculateMuscleRate(dailyData.muscleMass, dailyData.weight);
            const idealWeight = calculateIdealWeight(userInfo.height, userInfo.gender);
            const bloodPressureLevel = calculateBloodPressureLevel(dailyData.systolic, dailyData.diastolic);
            const bmiLevel = calculateBMILevel(bmi);
            const whrLevel = calculateWHRLevel(dailyData.whr, userInfo.gender);
            const visceralFatLevel = calculateVisceralFatLevel(dailyData.visceralFat);

            // 准备所有指标，用“-”占位
            const allMetrics = [
                // 基础指标
                { label: '日期', value: date },
                { label: '体重', value: dailyData.weight ? `${dailyData.weight} 斤` : '-' },
                { label: '体脂率', value: dailyData.fatRate ? `${dailyData.fatRate}%` : '-' },
                { label: '肌肉量', value: dailyData.muscleMass !== undefined && dailyData.muscleMass !== null ? `${dailyData.muscleMass} kg` : '-' },
                { label: '水分率', value: dailyData.waterRate !== undefined && dailyData.waterRate !== null ? `${dailyData.waterRate}%` : '-' },
                { label: '骨量', value: dailyData.boneMass !== undefined && dailyData.boneMass !== null ? `${dailyData.boneMass} kg` : '-' },
                { label: '内脏脂肪', value: dailyData.visceralFat !== undefined && dailyData.visceralFat !== null ? dailyData.visceralFat : '-' },
                { label: '腰围', value: dailyData.waist !== undefined && dailyData.waist !== null ? `${dailyData.waist} cm` : '-' },
                { label: '臀围', value: dailyData.hip !== undefined && dailyData.hip !== null ? `${dailyData.hip} cm` : '-' },
                { label: '收缩压', value: dailyData.systolic !== undefined && dailyData.systolic !== null ? `${dailyData.systolic} mmHg` : '-' },
                { label: '舒张压', value: dailyData.diastolic !== undefined && dailyData.diastolic !== null ? `${dailyData.diastolic} mmHg` : '-' },
                { label: '静息心率', value: dailyData.heartRate !== undefined && dailyData.heartRate !== null ? `${dailyData.heartRate} 次/分` : '-' },
                
                // 自动计算指标
                { label: 'BMI', value: bmi ? bmi : '-' },
                { label: '基础代谢率', value: bmr ? `${bmr} 大卡` : '-' },
                { label: '腰臀比', value: dailyData.whr !== undefined && dailyData.whr !== null ? dailyData.whr : '-' },
                
                // 衍生指标
                { label: '瘦体重', value: leanBodyMass ? `${leanBodyMass} 斤` : '-' },
                { label: '脂肪重量', value: fatMass ? `${fatMass} 斤` : '-' },
                { label: '肌肉率', value: muscleRate ? `${muscleRate}%` : '-' },
                { label: '理想体重', value: idealWeight ? `${idealWeight} 斤` : '-' },
                { label: 'BMI等级', value: bmiLevel && bmiLevel !== 'N/A' ? bmiLevel : '-' },
                { label: '血压等级', value: bloodPressureLevel && bloodPressureLevel !== 'N/A' ? bloodPressureLevel : '-' },
                { label: '腰臀比等级', value: whrLevel && whrLevel !== 'N/A' ? whrLevel : '-' },
                { label: '内脏脂肪等级', value: visceralFatLevel && visceralFatLevel !== 'N/A' ? visceralFatLevel : '-' }
            ];

            // 创建或获取指标容器
            let metricsContainer = document.querySelector('.daily-metrics');
            if (!metricsContainer) {
                // 创建指标容器
                metricsContainer = document.createElement('div');
                metricsContainer.className = 'summary daily-metrics';
                
                // 插入到DOM的可见位置 - 直接添加到body末尾
                document.body.appendChild(metricsContainer);
            }

            // 更新内容
            metricsContainer.innerHTML = `<h3>${date} 健康数据</h3>`;
            
            // 生成指标卡片 - 显示所有指标，用“-”占位
            const metricsGrid = document.createElement('div');
            metricsGrid.className = 'metrics-grid';
            metricsGrid.style.display = 'grid';
            metricsGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(250px, 1fr))';
            metricsGrid.style.gap = '15px';
            metricsGrid.style.marginTop = '20px';
            
            // 生成指标项
            allMetrics.forEach(metric => {
                const metricItem = document.createElement('div');
                metricItem.style.background = 'white';
                metricItem.style.borderRadius = '8px';
                metricItem.style.padding = '15px';
                metricItem.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.05)';
                
                metricItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 14px; color: #7f8c8d;">${metric.label}</span>
                        <span style="font-size: 18px; font-weight: 700; color: #2c3e50;">${metric.value}</span>
                    </div>
                `;
                
                metricsGrid.appendChild(metricItem);
            });
            
            metricsContainer.appendChild(metricsGrid);
        }

        // 添加数据
        function addData() {
            const date = document.getElementById('inputDate').value;
            const weight = parseFloat(document.getElementById('inputWeight').value);
            const fatRate = parseFloat(document.getElementById('inputFatRate').value);
            const muscleMass = parseFloat(document.getElementById('inputMuscleMass').value) || null;
            const waterRate = parseFloat(document.getElementById('inputWaterRate').value) || null;
            const visceralFat = parseFloat(document.getElementById('inputVisceralFat').value) || null;
            const boneMass = parseFloat(document.getElementById('inputBoneMass').value) || null;
            const waist = parseFloat(document.getElementById('inputWaist').value) || null;
            const hip = parseFloat(document.getElementById('inputHip').value) || null;
            const systolic = parseFloat(document.getElementById('inputSystolic').value) || null;
            const diastolic = parseFloat(document.getElementById('inputDiastolic').value) || null;
            const heartRate = parseFloat(document.getElementById('inputHeartRate').value) || null;

            if (!date || isNaN(weight)) {
                alert('请填写完整数据（日期和体重为必填项）');
                return;
            }

            // 自动计算衍生指标
            const bmi = calculateBMI(weight, userInfo.height);
            const bmr = calculateBMR(weight, userInfo.height, userInfo.age, userInfo.gender);
            const whr = calculateWHR(waist, hip);

            // 创建数据对象
            const dataItem = {
                date,
                weight,
                fatRate: isNaN(fatRate) ? null : fatRate,
                muscleMass,
                waterRate,
                visceralFat,
                boneMass,
                waist,
                hip,
                systolic,
                diastolic,
                heartRate,
                bmi,
                bmr: bmr ? Math.round(bmr) : null,
                whr
            };

            // 检查是否已存在该日期的数据
            const existingIndex = rawData.findIndex(item => item.date === date);
            if (existingIndex >= 0) {
                // 更新现有数据
                rawData[existingIndex] = dataItem;
            } else {
                // 添加新数据
                rawData.push(dataItem);
                // 按日期排序
                rawData.sort((a, b) => new Date(a.date) - new Date(b.date));
            }

            // 保存数据
            saveData();
            // 更新图表
            updateChart();
            // 更新指标
            updateMetrics();
            // 清空输入
            document.getElementById('inputDate').value = '';
            document.getElementById('inputWeight').value = '';
            document.getElementById('inputFatRate').value = '';
            document.getElementById('inputMuscleMass').value = '';
            document.getElementById('inputWaterRate').value = '';
            document.getElementById('inputVisceralFat').value = '';
            document.getElementById('inputBoneMass').value = '';
            document.getElementById('inputWaist').value = '';
            document.getElementById('inputHip').value = '';
            document.getElementById('inputSystolic').value = '';
            document.getElementById('inputDiastolic').value = '';
            document.getElementById('inputHeartRate').value = '';
        }

        // 导出数据
        function exportData() {
            // 将数据转换为JSON字符串，格式与data.json完全一致
            const dataStr = JSON.stringify(rawData, null, 4);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // 创建下载链接
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'data.json';
            link.click();
            
            // 释放URL对象
            URL.revokeObjectURL(link.href);
        }

        // 导入数据
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // 验证数据格式
                    if (Array.isArray(importedData) && importedData.every(item => 
                        item.hasOwnProperty('date') && 
                        item.hasOwnProperty('weight') && 
                        item.hasOwnProperty('fatRate')
                    )) {
                        // 导入数据并排序
                        rawData = importedData.sort((a, b) => new Date(a.date) - new Date(b.date));
                        // 保存数据
                        saveData();
                        // 更新图表和指标
                        updateChart();
                        updateMetrics();
                        alert('数据导入成功');
                    } else {
                        alert('数据格式不正确，请确保与原data.json格式一致');
                    }
                } catch (error) {
                    alert('数据解析失败，请确保文件格式正确');
                }
            };
            reader.readAsText(file);
        }

        // 初始化ECharts实例
        const chartDom = document.getElementById('chart');
        const myChart = echarts.init(chartDom);

        // 图表指标配置
        const chartMetrics = [
            { key: 'weight', name: '体重(斤)', unit: '斤', color: '#5470C6', yAxisIndex: 0 },
            { key: 'fatRate', name: '体脂率(%)', unit: '%', color: '#91CC75', yAxisIndex: 1 },
            { key: 'bmi', name: 'BMI', unit: '', color: '#fac858', yAxisIndex: 0 },
            { key: 'muscleMass', name: '肌肉量(kg)', unit: 'kg', color: '#ee6666', yAxisIndex: 0 },
            { key: 'waterRate', name: '水分率(%)', unit: '%', color: '#73c0de', yAxisIndex: 1 },
            { key: 'boneMass', name: '骨量(kg)', unit: 'kg', color: '#3ba272', yAxisIndex: 0 },
            { key: 'heartRate', name: '静息心率(次/分)', unit: '次/分', color: '#fc8452', yAxisIndex: 0 }
        ];

        // 当前显示的指标
        let currentMetrics = ['weight', 'fatRate'];

        // 更新图表
        function updateChart() {
            // 准备图表数据
            const dates = rawData.map(item => item.date);
            
            // 生成系列数据
            const series = currentMetrics.map(metricKey => {
                const metric = chartMetrics.find(m => m.key === metricKey);
                const data = rawData.map(item => item[metricKey] || null);
                return {
                    name: metric.name,
                    type: 'line',
                    smooth: true,
                    data: data,
                    yAxisIndex: metric.yAxisIndex,
                    lineStyle: {
                        width: 3,
                        color: metric.color
                    },
                    itemStyle: {
                        color: metric.color,
                        // 确保点可以被点击
                        emphasis: {
                            focus: 'series'
                        }
                    },
                    areaStyle: metric.yAxisIndex === 0 ? {
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [{
                                offset: 0,
                                color: `${metric.color}80`
                            }, {
                                offset: 1,
                                color: `${metric.color}20`
                            }]
                        }
                    } : undefined,
                    // 确保系列可以点击
                    clickable: true
                };
            });

            // 计算Y轴范围
            const yAxis0Data = rawData.map(item => {
                return currentMetrics
                    .filter(key => chartMetrics.find(m => m.key === key).yAxisIndex === 0)
                    .map(key => item[key])
                    .filter(val => val !== null);
            }).flat();

            const yAxis1Data = rawData.map(item => {
                return currentMetrics
                    .filter(key => chartMetrics.find(m => m.key === key).yAxisIndex === 1)
                    .map(key => item[key])
                    .filter(val => val !== null);
            }).flat();

            // 图表配置
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        label: {
                            backgroundColor: '#6a7985'
                        }
                    }
                },
                legend: {
                    data: series.map(s => s.name),
                    top: 10
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dates
                },
                yAxis: [
                    {
                        type: 'value',
                        name: series.find(s => s.yAxisIndex === 0)?.name || '数值',
                        min: yAxis0Data.length > 0 ? Math.min(...yAxis0Data) - 5 : 0,
                        max: yAxis0Data.length > 0 ? Math.max(...yAxis0Data) + 5 : 100,
                        position: 'left',
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: series.find(s => s.yAxisIndex === 0)?.lineStyle.color || '#5470C6'
                            }
                        },
                        axisLabel: {
                            formatter: '{value}'
                        }
                    },
                    {
                        type: 'value',
                        name: series.find(s => s.yAxisIndex === 1)?.name || '百分比(%)',
                        min: yAxis1Data.length > 0 ? Math.min(...yAxis1Data) - 5 : 0,
                        max: yAxis1Data.length > 0 ? Math.max(...yAxis1Data) + 5 : 100,
                        position: 'right',
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: series.find(s => s.yAxisIndex === 1)?.lineStyle.color || '#91CC75'
                            }
                        },
                        axisLabel: {
                            formatter: '{value}'
                        }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        type: 'slider',
                        start: 0,
                        end: 100
                    }
                ],
                series: series,
                // 添加点击事件配置
                emphasis: {
                    focus: 'series'
                }
            };

            // 渲染图表
            option && myChart.setOption(option);
            
            // 重新添加图表点击事件，确保图表更新后事件仍然有效
            addChartClickEvent();
        }

        // 添加图表点击事件 - 在图表初始化后添加
        function addChartClickEvent() {
            // 移除之前的所有事件监听，确保没有冲突
            myChart.off('click');
            
            // 添加ECharts原生点击事件
            myChart.on('click', function(params) {
                // 确保params有name属性
                if (params && params.name) {
                    const date = params.name;
                    showDailyMetrics(date);
                }
            });
            
            // 添加DOM点击事件作为备选方案
            myChart.getDom().addEventListener('click', function(e) {
                // 使用ECharts API从点击位置获取数据
                try {
                    // 获取点击位置相对于图表容器的坐标
                    const rect = myChart.getDom().getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // 使用ECharts的convertFromPixel方法获取数据坐标
                    const pointInPixel = [x, y];
                    const pointInGrid = myChart.convertFromPixel('grid', pointInPixel);
                    
                    // 获取对应的日期索引
                    if (pointInGrid && pointInGrid[0] !== null && pointInGrid[0] !== undefined) {
                        const dataIndex = Math.round(pointInGrid[0]);
                        
                        // 确保索引在有效范围内
                        if (dataIndex >= 0 && dataIndex < rawData.length) {
                            const date = rawData[dataIndex].date;
                            showDailyMetrics(date);
                        }
                    }
                } catch (error) {
                    // 忽略错误，不影响用户体验
                }
            });
        }

        // 初始化数据
        async function init() {
            await initData();
            renderMetricSelector();
            // 添加图表点击事件
            addChartClickEvent();
        }
        
        // 启动应用
        init();

        // 指标选择器
        function renderMetricSelector() {
            const selectorContainer = document.createElement('div');
            selectorContainer.className = 'summary';
            selectorContainer.innerHTML = `
                <h3>图表指标选择</h3>
                <div class="metric-selector" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${chartMetrics.map(metric => `
                        <label style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: ${currentMetrics.includes(metric.key) ? metric.color : '#ecf0f1'}; color: ${currentMetrics.includes(metric.key) ? 'white' : '#333'}; border-radius: 20px; cursor: pointer; transition: all 0.3s;">
                            <input type="checkbox" name="metric" value="${metric.key}" ${currentMetrics.includes(metric.key) ? 'checked' : ''} onchange="toggleMetric('${metric.key}', this.checked)" style="margin: 0;">
                            <span>${metric.name}</span>
                        </label>
                    `).join('')}
                </div>
            `;
            
            // 插入到图表容器之前
            const chartContainer = document.getElementById('chart');
            chartContainer.parentNode.insertBefore(selectorContainer, chartContainer);
        }

        // 切换指标
        function toggleMetric(metricKey, isChecked) {
            if (isChecked) {
                if (!currentMetrics.includes(metricKey)) {
                    currentMetrics.push(metricKey);
                }
            } else {
                currentMetrics = currentMetrics.filter(key => key !== metricKey);
                // 确保至少有一个指标显示
                if (currentMetrics.length === 0) {
                    currentMetrics.push('weight');
                    document.querySelector(`input[value="weight"]`).checked = true;
                }
            }
            updateChart();
        }

        // 更新指标
        function updateMetrics() {
            if (rawData.length === 0) return;

            const firstData = rawData[0];
            const lastData = rawData[rawData.length - 1];
            
            // 计算变化值
            const weightChange = lastData.weight - firstData.weight;
            const fatRateChange = (lastData.fatRate && firstData.fatRate) ? (lastData.fatRate - firstData.fatRate) : null;
            const weightChangePercent = ((weightChange / firstData.weight) * 100).toFixed(1);
            const muscleChange = (lastData.muscleMass && firstData.muscleMass) ? (lastData.muscleMass - firstData.muscleMass) : null;
            const bmiChange = (lastData.bmi && firstData.bmi) ? (parseFloat(lastData.bmi) - parseFloat(firstData.bmi)).toFixed(1) : null;

            // 更新基础指标卡片
            document.querySelector('.metric-card:nth-child(1) .value').textContent = `${firstData.weight} 斤`;
            document.querySelector('.metric-card:nth-child(1) .change').textContent = firstData.date;
            document.querySelector('.metric-card:nth-child(2) .value').textContent = `${lastData.weight} 斤`;
            document.querySelector('.metric-card:nth-child(2) .change').textContent = lastData.date;
            document.querySelector('.metric-card:nth-child(3) .value').textContent = `${weightChange > 0 ? '+' : ''}${weightChange.toFixed(1)} 斤`;
            document.querySelector('.metric-card:nth-child(3) .change').innerHTML = `${weightChange > 0 ? '↑' : '↓'} ${Math.abs(weightChangePercent)}%`;
            document.querySelector('.metric-card:nth-child(3) .change').className = `change ${weightChange < 0 ? 'positive' : 'negative'}`;
            document.querySelector('.metric-card:nth-child(4) .value').textContent = `${firstData.fatRate}% → ${lastData.fatRate}%`;
            
            // 检查是否有fatRateChange数据
            if (fatRateChange !== null) {
                document.querySelector('.metric-card:nth-child(4) .change').innerHTML = `${fatRateChange > 0 ? '↑' : '↓'} ${Math.abs(fatRateChange).toFixed(1)}%`;
                document.querySelector('.metric-card:nth-child(4) .change').className = `change ${fatRateChange < 0 ? 'positive' : 'negative'}`;
            } else {
                document.querySelector('.metric-card:nth-child(4) .change').innerHTML = 'N/A';
                document.querySelector('.metric-card:nth-child(4) .change').className = 'change';
            }

            // 动态添加新增指标卡片
            updateAdditionalMetrics(lastData);
        }

        // 更新新增指标
        function updateAdditionalMetrics(lastData) {
            let metricsContainer = document.querySelector('.additional-metrics');
            if (!metricsContainer) {
                // 创建新增指标容器
                metricsContainer = document.createElement('div');
                metricsContainer.className = 'metrics additional-metrics';
                const summarySection = document.querySelector('.summary:nth-of-type(3)');
                summarySection.parentNode.insertBefore(metricsContainer, summarySection.nextSibling);
            }

            // 新增指标数据
            const additionalMetrics = [
                { label: '当前BMI', value: lastData.bmi || 'N/A', unit: '', desc: '身体质量指数' },
                { label: '基础代谢', value: lastData.bmr || 'N/A', unit: ' 大卡', desc: '基础代谢率' },
                { label: '肌肉量', value: lastData.muscleMass || 'N/A', unit: ' kg', desc: '肌肉质量' },
                { label: '水分率', value: lastData.waterRate || 'N/A', unit: ' %', desc: '身体水分比例' },
                { label: '骨量', value: lastData.boneMass || 'N/A', unit: ' kg', desc: '骨骼质量' },
                { label: '腰臀比', value: lastData.whr || 'N/A', unit: '', desc: '腰围与臀围比值' },
                { label: '内脏脂肪', value: lastData.visceralFat || 'N/A', unit: '', desc: '内脏脂肪等级' },
                { label: '静息心率', value: lastData.heartRate || 'N/A', unit: ' 次/分', desc: '安静状态心率' }
            ];

            // 生成指标卡片
            metricsContainer.innerHTML = additionalMetrics.map(metric => `
                <div class="metric-card">
                    <h4>${metric.label}</h4>
                    <div class="value">${metric.value}${metric.unit}</div>
                    <div class="change">${metric.desc}</div>
                </div>
            `).join('');
        }

        // 响应式调整
        window.addEventListener('resize', function() {
            myChart.resize();
        });

        // 时间段切换功能
        document.querySelectorAll('.period-btn').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                const period = this.getAttribute('data-period');
                let startIndex = 0;
                
                if (period === '3months') {
                    // 显示最近3个月的数据
                    startIndex = Math.max(0, rawData.length - 90);
                } else if (period === '1month') {
                    // 显示最近1个月的数据
                    startIndex = Math.max(0, rawData.length - 30);
                }
                
                // 更新数据缩放
                myChart.setOption({
                    dataZoom: [
                        {
                            type: 'inside',
                            start: (startIndex / rawData.length) * 100,
                            end: 100
                        },
                        {
                            type: 'slider',
                            start: (startIndex / rawData.length) * 100,
                            end: 100
                        }
                    ]
                });
            });
        });


    </script>
</body>
</html>